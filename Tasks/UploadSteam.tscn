[gd_scene load_steps=2 format=3 uid="uid://b7iec2eyiepn8"]

[sub_resource type="GDScript" id="GDScript_ftiq7"]
script/source = "extends Task

@onready var vdf_file: OptionButton = %VDFFile

static var vdf_list: PackedStringArray

func _get_task_name() -> String:
	return \"Upload Steam\"

func _get_execute_string() -> String:
	return \"Steam Build (%s)\" % vdf_file.text

func _get_command() -> String:
	return Data.global_config.get(\"steam_cmd_path\")

func _get_arguments() -> PackedStringArray:
	var ret: PackedStringArray
	
	ret.append(\"+login\")
	ret.append(Data.global_config.get(\"steam_username\", \"\"))
	ret.append(Data.global_config.get(\"steam_password\", \"\"))
	
	ret.append(\"+run_app_build\")
	ret.append(ProjectSettings.globalize_path(get_temp_vdf_path()))
	
	ret.append(\"+quit\")
	
	return ret

func _prepare() -> void:
	var vdf_file_path := Data.project_path.path_join(vdf_file.get_selected_metadata())
	var vdf_file_dir := vdf_file_path.get_base_dir()
	
	var app_build_lines := FileAccess.open(vdf_file_path, FileAccess.READ).get_as_text().split(\"\\n\")
	
	for i in app_build_lines.size():
		var line := app_build_lines[i]
		
		if line.contains(\"ContentRoot\"):
			line = line.replace(\"%s\", get_global_content_path())
			app_build_lines[i] = line
		elif line.contains(\"BuildOutput\"):
			line = line.replace(\"%s\", Data.global_config.get(\"steam_output\"))
			app_build_lines[i] = line
		elif line.contains(\"DEP\\\"\"):
			var j := line.find(\"DEP\\\"\") + 4
			var k := line.find(\"\\\"\", j)
			var depot_name := line.substr(j, k - j)
			
			line = str(line.substr(0, j - 4), \"\\\"\", vdf_file_dir.path_join(depot_name), \"\\\"\")
			app_build_lines[i] = line
	
	var temp_vdf := FileAccess.open(get_temp_vdf_path(), FileAccess.WRITE)
	temp_vdf.store_string(\"\\n\".join(app_build_lines))

func _initialize(project_path: String):
	super(project_path)
	
	if vdf_list.is_empty():
		scan_for_vdf(Data.project_path, vdf_list)
	
	for file in vdf_list:
		vdf_file.add_item(file.get_file())
		vdf_file.set_item_metadata(-1, file)
		vdf_file.set_item_tooltip(-1, file)

func scan_for_vdf(directory: String, list: PackedStringArray):
	for file in DirAccess.get_files_at(directory):
		if file.get_extension() == \"vdf\":
			var path := directory.path_join(file)
			
			var f := FileAccess.open(path, FileAccess.READ)
			for line in f.get_as_text().split(\"\\n\"):
				if line.contains(\"AppBuild\"):
					list.append(path.trim_prefix(Data.project_path + \"/\"))
					break
	
	for dir in DirAccess.get_directories_at(directory):
		if not dir.begins_with(\".\"):
			scan_for_vdf(directory.path_join(dir), list)

func _load():
	var file: String = data[\"vdf_path\"]
	
	for i in vdf_file.item_count:
		if vdf_file.get_item_metadata(i) == file:
			vdf_file.selected = i
			break

func _store():
	data[\"vdf_path\"] = vdf_file.get_selected_metadata()

func _get_task_info() -> PackedStringArray:
	return [
		\"Uploads files to Steam based on a given VDF file and configured content paths. Requires steamcmd.exe.\",
		\"VDF File|File used as a base to upload. Only \\\"non-simple\\\" VDF files are supported. Note that a special format is expected: ContentRoot and BuildOutput variables should be \\\"%s\\\", as they are filled by Project Builds. Also depot list should list files starting with DEP (e.g. DEP\\\"Demo.vdf\\\"). File paths are relative to the base file directory.\"] ## TODO: można w sumie dać plik podglądawy i wyświetlać go pod przyciskiem??

func get_global_content_path() -> String:
	var content_root: String = Data.local_config.get(\"steam_content_root\", \"\")
	return Data.project_path.path_join(content_root)

func get_temp_vdf_path() -> String:
	return \"user://BuildSteam.vdf\"
"

[node name="UploadSteam" type="VBoxContainer"]
offset_right = 272.0
offset_bottom = 58.0
script = SubResource("GDScript_ftiq7")

[node name="HBoxContainer" type="HBoxContainer" parent="."]
layout_mode = 2
alignment = 1

[node name="Label" type="Label" parent="HBoxContainer"]
layout_mode = 2
text = "VDF File"
horizontal_alignment = 1

[node name="VDFFile" type="OptionButton" parent="HBoxContainer"]
unique_name_in_owner = true
layout_mode = 2
size_flags_horizontal = 4
